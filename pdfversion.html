<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #content { display: none; }
    </style>
</head>
<body>
    <div id="content"></div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const unit = decodeURIComponent(urlParams.get('unit') || 'Unknown Unit');
        const toleranceBefore = decodeURIComponent(urlParams.get('tolBefore') || '2');
        const toleranceAfter = decodeURIComponent(urlParams.get('tolAfter') || '2');
        const baseLineBefore = decodeURIComponent(urlParams.get('baseBefore') || 'N/A');
        const baseLineAfter = decodeURIComponent(urlParams.get('baseAfter') || 'N/A');
        const avgBefore = decodeURIComponent(urlParams.get('avgBefore') || '0.00 mm');
        const avgAfter = decodeURIComponent(urlParams.get('avgAfter') || '0.00 mm');
        const gridBefore = JSON.parse(decodeURIComponent(urlParams.get('gridBefore') || '{}'));
        const gridAfter = JSON.parse(decodeURIComponent(urlParams.get('gridAfter') || '{}'));
        const customLabels = JSON.parse(decodeURIComponent(urlParams.get('customLabels') || '{}'));
        const beforeWeldDiffs = JSON.parse(decodeURIComponent(urlParams.get('beforeWeldDiffs') || '{}'));
        const hasAfterWeldData = urlParams.get('hasAfterWeldData') === 'true';
        const rows = parseInt(urlParams.get('rows') || '4');
        const cols = parseInt(urlParams.get('cols') || '4');
        const isVertical = urlParams.get('isVertical') === 'true';

        // Generate PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' }).replace(/\//g, '');
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false }).replace(':', '');
        const fileName = `${unit}WaterLevel${dateStr}${timeStr}.pdf`;

        const margin = 15;
        const pageWidth = 210;
        const pageHeight = 297;
        const contentWidth = pageWidth - 2 * margin;

        function addPageHeaderAndBorder(pageTitle) {
            doc.setLineWidth(0.5);
            doc.rect(margin, margin, contentWidth, pageHeight - 2 * margin);
            doc.setFontSize(16);
            doc.text('Cochin Shipyard Limited', margin + contentWidth / 2, margin + 10, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`${unit} ${pageTitle}`, margin + contentWidth / 2, margin + 20, { align: 'center' });
            doc.text(`Date: ${now.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })}`, pageWidth - margin - 10, margin + 20, { align: 'right' });
        }

        // Before Weld Data
        addPageHeaderAndBorder('Before Weld Water Level Details');
        let startY = margin + 30;
        doc.setFontSize(12);
        doc.text('Before Weld Data', margin + 10, startY);
        startY += 5;

        const beforeTableData = [];
        const beforeBL = parseFloat(baseLineBefore);
        const beforeReference = !isNaN(beforeBL) ? beforeBL : parseFloat(avgBefore);
        const beforeTol = parseFloat(toleranceBefore) || 2;

        for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
                const defaultLabel = String.fromCharCode(65 + i) + (j + 1);
                const label = customLabels[defaultLabel] || defaultLabel;
                const value = gridBefore[defaultLabel] || 'N/A';
                let diff = !isNaN(value) && value !== 'N/A' ? (parseFloat(value) - beforeReference).toFixed(2) : '0.00';
                if (isVertical) diff = (-diff).toFixed(2);
                const color = !isNaN(value) && value !== 'N/A' && Math.abs(diff) <= beforeTol ? [22, 163, 74] : [220, 38, 38];
                beforeTableData.push([label, value, { content: `${diff > 0 ? '+' : ''}${diff} mm`, styles: { textColor: color } }]);
            }
        }

        doc.autoTable({
            startY: startY,
            head: [['Cell', 'Value (mm)', 'Difference (mm)']],
            body: beforeTableData,
            theme: 'grid',
            styles: { halign: 'center', cellPadding: 2, lineHeight: 1.5 },
            margin: { left: margin + 10, right: margin + 10 },
        });

        let footerY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(10);
        doc.text(`Before Weld - Tolerance: ±${beforeTol} mm`, margin + 10, footerY);
        doc.text(!isNaN(beforeBL) ? `Base Line: ${beforeBL.toFixed(2)} mm` : `Plain Average: ${avgBefore} mm`, margin + 10, footerY + 5);
        doc.text('VT Soft © 2025', margin + contentWidth / 2, pageHeight - margin - 5, { align: 'center' });

        // After Weld Data (if applicable)
        if (hasAfterWeldData) {
            doc.addPage();
            addPageHeaderAndBorder('After Weld Water Level Details');
            startY = margin + 30;
            doc.setFontSize(12);
            doc.text('After Weld Data', margin + 10, startY);
            startY += 5;

            const afterTableData = [];
            const afterBL = parseFloat(baseLineAfter);
            const afterReference = !isNaN(afterBL) ? afterBL : parseFloat(avgAfter);
            const afterTol = parseFloat(toleranceAfter) || 2;

            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const defaultLabel = String.fromCharCode(65 + i) + (j + 1);
                    const label = customLabels[defaultLabel] || defaultLabel;
                    const value = gridAfter[defaultLabel] || 'N/A';
                    let diff = !isNaN(value) && value !== 'N/A' ? (parseFloat(value) - afterReference).toFixed(2) : '0.00';
                    if (isVertical) diff = (-diff).toFixed(2);
                    const color = !isNaN(value) && value !== 'N/A' && Math.abs(diff) <= afterTol ? [22, 163, 74] : [220, 38, 38];
                    let diffText = `${diff > 0 ? '+' : ''}${diff} mm`;
                    if (beforeWeldDiffs[label]) {
                        diffText += ` (${beforeWeldDiffs[label]})`;
                    }
                    afterTableData.push([label, value, { content: diffText, styles: { textColor: color } }]);
                }
            }

            doc.autoTable({
                startY: startY,
                head: [['Cell', 'Value (mm)', 'Difference (mm)']],
                body: afterTableData,
                theme: 'grid',
                styles: { halign: 'center', cellPadding: 2, lineHeight: 1.5 },
                margin: { left: margin + 10, right: margin + 10 },
            });

            footerY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.text(`After Weld - Tolerance: ±${afterTol} mm`, margin + 10, footerY);
            doc.text(!isNaN(afterBL) ? `Base Line: ${afterBL.toFixed(2)} mm` : `Plain Average: ${avgAfter} mm`, margin + 10, footerY + 5);
            doc.text('VT Soft © 2025', margin + contentWidth / 2, pageHeight - margin - 5, { align: 'center' });
        }

        // Save PDF
        doc.save(fileName);
    </script>
</body>
</html>