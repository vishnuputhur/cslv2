<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSL Blood Donation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-red: #ff3b30;
            --dark-red: #d70015;
            --light-red: #ffebee;
            --text-dark: #2c3e50;
            --text-light: #7f8c8d;
            --bg-light: #fff5f5;
            --bg-white: #ffffff;
            --border-color: #e8e8e8;
            --shadow-soft: 0 4px 12px rgba(0,0,0,0.08);
            --gradient-primary: linear-gradient(135deg, #ff3b30, #d70015);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: var(--gradient-primary);
            height: 75px;
            color: white;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(215, 0, 21, 0.2);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .title-group {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .app-title {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .slogan {
            font-size: 0.65rem;
            font-weight: 400;
            opacity: 0.9;
        }
        
        .blood-drop {
            color: white;
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .admin-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        /* Main Content */
        .main-container {
            max-width: 1200px;
            margin: 90px auto 50px;
            padding: 0 20px;
        }
        
        /* Congrats Banner - Scrolling Names */
        .congrats-banner {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-soft);
        }
        
        .congrats-title {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 5px;
            display: block;
            text-align: center;
        }

        .marquee-container {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }

        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
            font-weight: 600;
            font-size: 0.95rem;
        }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
        
        /* Blood Filter */
        .filter-section {
            background: var(--bg-white);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }
        
        .blood-groups {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        
        .blood-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-white);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .blood-btn.blood-btn-all {
            flex: 2;
            min-width: 120px;
            font-size: 0.9rem;
            padding: 8px 16px;
            font-weight: 700;
            background: var(--gradient-primary);
            color: white;
            border: none;
            order: 1;
        }
        
        .blood-btn.blood-btn-group { flex: 1; min-width: 70px; }
        .blood-btn.blood-btn-group.active { background: var(--primary-red); color: white; border-color: var(--primary-red); }
        
        /* Donor Cards */
        .donor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .donor-card {
            background: var(--bg-white);
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--shadow-soft);
            border-left: 4px solid var(--primary-red);
            transition: all 0.3s;
            position: relative;
            padding-top: 25px; /* Space for top badge */
        }
        
        .donor-card.recent-donor { opacity: 0.6; border-left: 4px solid #cccccc; }
        
        /* Top Center Badge */
        .remaining-days {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #ff9800;
            color: white;
            padding: 2px 12px;
            border-radius: 0 0 10px 10px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 2;
            white-space: nowrap;
        }
        
        .remaining-days.ready { background: #4CAF50; }
        
        .donor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .donor-name { font-weight: 600; font-size: 1rem; color: var(--text-dark); }
        .blood-badge { background: var(--light-red); color: var(--primary-red); padding: 3px 10px; border-radius: 12px; font-weight: 700; font-size: 0.8rem; }
        
        .donor-details { font-size: 0.85rem; margin-bottom: 10px; }
        .detail-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
        .detail-row i { color: var(--primary-red); width: 16px; font-size: 0.9rem; }
        .mobile-link { color: var(--primary-red); text-decoration: none; font-weight: 500; }
        
        .last-donation { font-size: 0.8rem; color: var(--text-light); display: flex; align-items: center; gap: 5px; margin-top: 8px; }
        
        .actions { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); display: flex; gap: 8px; }
        .action-btn { padding: 5px 10px; border: none; border-radius: 6px; font-size: 0.75rem; cursor: pointer; flex: 1; }
        .update-btn { background: #ff9800; color: white; }
        .edit-btn { background: #2196f3; color: white; }
        .delete-btn { background: #f44336; color: white; }
        
        /* Footer */
        .footer {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-light);
            text-align: center;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            font-size: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
            z-index: 90;
        }
        .footer a { color: var(--primary-red); text-decoration: none; font-weight: 600; }

        /* Floating Add Button */
        .add-btn {
            position: fixed;
            bottom: 60px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary-red);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
            z-index: 99;
        }
        
        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-white); border-radius: 12px; width: 90%; max-width: 400px; padding: 20px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close-modal { font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 0.85rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; }
        .submit-btn { background: var(--primary-red); color: white; border: none; padding: 10px; border-radius: 6px; width: 100%; font-weight: 600; cursor: pointer; margin-top: 5px; }
        .hidden { display: none !important; }

        @media (max-width: 600px) {
            .donor-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <i class="fas fa-tint blood-drop"></i>
                <div class="title-group">
                    <h1 class="app-title">CSL Blood Donation</h1>
                    <span class="slogan">Be the reason someone breathes</span>
                </div>
            </div>
            <div class="admin-section">
                <button id="loginBtn" class="admin-btn"><i class="fas fa-user"></i></button>
                <button id="logoutBtn" class="admin-btn hidden"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </header>
    
    <main class="main-container">
        <div id="congratsBanner" class="congrats-banner hidden">
            <span class="congrats-title">Congratulations our recent heroes</span>
            <div class="marquee-container">
                <div class="marquee-content" id="congratsNames"></div>
            </div>
        </div>
        
        <section class="filter-section">
            <div class="blood-groups">
                <button class="blood-btn blood-btn-group" data-group="A+">A+</button>
                <button class="blood-btn blood-btn-group" data-group="A-">A-</button>
                <button class="blood-btn blood-btn-group" data-group="B+">B+</button>
                <button class="blood-btn blood-btn-group" data-group="B-">B-</button>
                <button class="blood-btn blood-btn-all active" data-group="all">ALL GROUPS</button>
                <button class="blood-btn blood-btn-group" data-group="O+">O+</button>
                <button class="blood-btn blood-btn-group" data-group="O-">O-</button>
                <button class="blood-btn blood-btn-group" data-group="AB+">AB+</button>
                <button class="blood-btn blood-btn-group" data-group="AB-">AB-</button>
            </div>
        </section>
        
        <div id="donorList"></div>
    </main>
    
    <button id="addBtn" class="add-btn"><i class="fas fa-plus"></i></button>
    <footer class="footer">Powered by <a href="https://vtsoft.netlify.app" target="_blank">VTSoft</a> © 2026</footer>
    
    <div id="addModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add Donor</h3><span class="close-modal">&times;</span></div>
            <form id="addForm">
                <div class="form-group"><label>Name *</label><input type="text" id="name" required></div>
                <div class="form-group"><label>CSL Code *</label><input type="text" id="csl" required></div>
                <div class="form-group"><label>Mobile *</label><input type="tel" id="mobile1" required></div>
                <div class="form-group"><label>Mobile 2 (Optional)</label><input type="tel" id="mobile2"></div>
                <div class="form-group"><label>Blood Group *</label>
                    <select id="blood" required>
                        <option value="">Select</option><option value="A+">A+</option><option value="A-">A-</option>
                        <option value="B+">B+</option><option value="B-">B-</option><option value="O+">O+</option>
                        <option value="O-">O-</option><option value="AB+">AB+</option><option value="AB-">AB-</option>
                    </select>
                </div>
                <div class="form-group"><label>Last Donation *</label><input type="date" id="lastDate" required></div>
                <button type="submit" class="submit-btn">Add Donor</button>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Edit Donor</h3><span class="close-modal">&times;</span></div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group"><label>Name *</label><input type="text" id="editName" required></div>
                <div class="form-group"><label>CSL Code *</label><input type="text" id="editCsl" required></div>
                <div class="form-group"><label>Mobile *</label><input type="tel" id="editMobile1" required></div>
                <div class="form-group"><label>Mobile 2</label><input type="tel" id="editMobile2"></div>
                <div class="form-group"><label>Blood Group *</label>
                    <select id="editBlood" required>
                        <option value="A+">A+</option><option value="A-">A-</option><option value="B+">B+</option>
                        <option value="B-">B-</option><option value="O+">O+</option><option value="O-">O-</option>
                        <option value="AB+">AB+</option><option value="AB-">AB-</option>
                    </select>
                </div>
                <div class="form-group"><label>Last Donation *</label><input type="date" id="editLastDate" required></div>
                <button type="submit" class="submit-btn">Update Donor</button>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Admin Login</h3><span class="close-modal">&times;</span></div>
            <form id="loginForm">
                <div class="form-group"><label>Password</label><input type="password" id="password" required></div>
                <button type="submit" class="submit-btn">Login</button>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCCjWVI1hB3sbu0JiA4viW1BK81xbMML-U",
            authDomain: "csl-calculations.firebaseapp.com",
            projectId: "csl-calculations",
            storageBucket: "csl-calculations.firebasestorage.app",
            messagingSenderId: "887219643486",
            appId: "1:887219643486:web:0cb001f2c72039a00240cf"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let donors = [];
        let selectedGroup = 'all';
        let isAdmin = localStorage.getItem('cslAdmin') === 'true';
        const ADMIN_PASS = "vishnu425";

        function renderDonors() {
            const list = document.getElementById('donorList');
            const filtered = selectedGroup === 'all' ? donors : donors.filter(d => d.bloodGroup === selectedGroup);
            filtered.sort((a,b) => new Date(a.lastDonation) - new Date(b.lastDonation));

            let html = '<div class="donor-grid">';
            filtered.forEach(d => {
                const diff = new Date() - new Date(d.lastDonation);
                const daysPast = Math.floor(diff / (1000 * 60 * 60 * 24));
                const daysLeft = Math.max(0, 90 - daysPast);
                const isReady = daysLeft === 0;

                html += `
                    <div class="donor-card ${!isReady ? 'recent-donor' : ''}">
                        <div class="remaining-days ${isReady ? 'ready' : ''}">
                            ${isReady ? 'READY' : daysLeft + ' DAYS LEFT'}
                        </div>
                        <div class="donor-header">
                            <div class="donor-name">${d.name}</div>
                            <div class="blood-badge">${d.bloodGroup}</div>
                        </div>
                        <div class="donor-details">
                            <div class="detail-row"><i class="fas fa-id-badge"></i><span>${d.cslCode}</span></div>
                            <div class="detail-row"><i class="fas fa-phone"></i><a href="tel:${d.mobile1}" class="mobile-link">${d.mobile1}</a></div>
                            ${d.mobile2 ? `<div class="detail-row"><i class="fas fa-phone-alt"></i><a href="tel:${d.mobile2}" class="mobile-link">${d.mobile2}</a></div>` : ''}
                            <div class="last-donation"><i class="fas fa-calendar-alt"></i> ${d.lastDonation} (${daysPast} days ago)</div>
                        </div>
                        <div class="actions">
                            <button class="action-btn update-btn" onclick="updateDate('${d.id}')">Update</button>
                            ${isAdmin ? `
                                <button class="action-btn edit-btn" onclick="openEdit('${d.id}')">Edit</button>
                                <button class="action-btn delete-btn" onclick="deleteDonor('${d.id}')">Del</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html + '</div>';
            updateBanner();
        }

        function updateBanner() {
            const banner = document.getElementById('congratsBanner');
            const namesDiv = document.getElementById('congratsNames');
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
            const heroes = donors.filter(d => new Date(d.lastDonation) >= thirtyDaysAgo);

            if (heroes.length > 0) {
                banner.classList.remove('hidden');
                namesDiv.innerHTML = heroes.map(h => h.name).join(' • ');
            } else {
                banner.classList.add('hidden');
            }
        }

        function updateDate(id) {
            const today = new Date().toISOString().split('T')[0];
            if(confirm("Update donation date to today?")) {
                db.collection("donors").doc(id).update({ lastDonation: today });
            }
        }

        function deleteDonor(id) {
            if(confirm("Delete this donor?")) {
                db.collection("donors").doc(id).delete();
            }
        }

        function openEdit(id) {
            const d = donors.find(x => x.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('editName').value = d.name;
            document.getElementById('editCsl').value = d.cslCode;
            document.getElementById('editMobile1').value = d.mobile1;
            document.getElementById('editMobile2').value = d.mobile2 || '';
            document.getElementById('editBlood').value = d.bloodGroup;
            document.getElementById('editLastDate').value = d.lastDonation;
            document.getElementById('editModal').style.display = 'flex';
        }

        // Event Listeners & Auth
        document.querySelectorAll('.blood-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelector('.blood-btn.active').classList.remove('active');
                btn.classList.add('active');
                selectedGroup = btn.dataset.group;
                renderDonors();
            };
        });

        document.getElementById('loginBtn').onclick = () => document.getElementById('loginModal').style.display='flex';
        document.getElementById('addBtn').onclick = () => document.getElementById('addModal').style.display='flex';
        document.querySelectorAll('.close-modal').forEach(c => c.onclick = () => document.querySelectorAll('.modal').forEach(m => m.style.display='none'));

        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            if(document.getElementById('password').value === ADMIN_PASS) {
                localStorage.setItem('cslAdmin', 'true');
                location.reload();
            } else { alert("Wrong password"); }
        };

        document.getElementById('logoutBtn').onclick = () => { localStorage.removeItem('cslAdmin'); location.reload(); };

        if(isAdmin) {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
        }

        document.getElementById('addForm').onsubmit = (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('name').value,
                cslCode: document.getElementById('csl').value,
                mobile1: document.getElementById('mobile1').value,
                mobile2: document.getElementById('mobile2').value,
                bloodGroup: document.getElementById('blood').value,
                lastDonation: document.getElementById('lastDate').value
            };
            db.collection("donors").add(data).then(() => {
                document.getElementById('addModal').style.display='none';
                e.target.reset();
            });
        };

        document.getElementById('editForm').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const data = {
                name: document.getElementById('editName').value,
                cslCode: document.getElementById('editCsl').value,
                mobile1: document.getElementById('editMobile1').value,
                mobile2: document.getElementById('editMobile2').value,
                bloodGroup: document.getElementById('editBlood').value,
                lastDonation: document.getElementById('editLastDate').value
            };
            db.collection("donors").doc(id).update(data).then(() => {
                document.getElementById('editModal').style.display='none';
            });
        };

        db.collection("donors").onSnapshot(snap => {
            donors = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
            renderDonors();
        });
    </script>
</body>
</html>
