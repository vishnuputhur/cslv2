<!DOCTYPE html>
<html lang="ml">
<head>
 <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-21G1BS7S3S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-21G1BS7S3S');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Solar Plant Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f1f5f9; font-family: 'Segoe UI', sans-serif; font-size: 13px; scroll-behavior: smooth; }
        .glass-card { background: white; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; padding: 10px; }
        header { position: fixed; top: 0; width: 100%; z-index: 50; background: #dcfce7; color: #166534; height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-bottom: 1px solid #bbf7d0; }
        footer { position: fixed; bottom: 0; width: 100%; font-size: 0.6rem; background: #fff; height: 25px; display: flex; align-items: center; justify-content: center; color: #94a3b8; border-top: 1px solid #eee; }
        .main-content { margin-top: 70px; margin-bottom: 80px; }
        .input-box { border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px; width: 100%; height: 38px; outline: none; font-size: 14px; }
        .input-box:focus { border-color: #22c55e; }
        .stat-val { font-size: 1.1rem; font-weight: 800; color: #1e293b; line-height: 1; }
        .stat-avg { font-size: 0.7rem; color: #64748b; font-weight: 500; margin-top: 2px; }
        #resetModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
        .legend-item { display: flex; align-items: center; font-size: 9px; font-weight: bold; }
        .legend-color { width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; }
        /* Floating Button */
        .fab { position: fixed; bottom: 40px; right: 20px; background: #22c55e; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 40; border: none; }
        /* Today's Usage Breakdown */
        .usage-breakdown { font-size: 9px; font-weight: 600; }
        .solar-use { color: #f59e0b; }
        .grid-use { color: #ef4444; }
        /* Today's Production in blue box */
        .today-prod { 
            font-size: 0.7rem; 
            color: #3b82f6; 
            font-weight: 600; 
            margin-top: 3px;
            padding: 2px 6px;
            background: #eff6ff;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <header class="shadow-sm">
        <div class="font-bold uppercase tracking-wider text-sm">My Solar Plant <i class="fas fa-leaf text-green-600 ml-1"></i></div>
        <div id="lastUpdateText" class="text-[9px] text-green-700 opacity-70 mt-0.5">Last Updated: --</div>
        <!-- HEADER-ൽ നിന്ന് today production എടുത്തു മാറ്റി -->
    </header>

    <div class="main-content p-3 space-y-3">
        
        <div class="grid grid-cols-2 gap-2">
            <div class="glass-card border-l-4 border-blue-500">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Total Production</p>
                <p id="totalProd" class="stat-val">0.0</p>
                <!-- PRODUCTION BOX-ൽ ഇന്നത്തെ production ചേർത്തു -->
                <div id="todayProdText" class="today-prod">Today: 0.0 units</div>
                <p id="avgProd" class="stat-avg">Avg: 0.0/day</p>
            </div>
            <div class="glass-card border-l-4 border-orange-500">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Home Usage (Total)</p>
                <p id="totalUse" class="stat-val">0.0</p>
                <div id="todayUsageBreakdown" class="usage-breakdown">
                    <span class="solar-use">Today Solar: 0.0</span> | <span class="grid-use">Today Grid: 0.0</span>
                </div>
                <p id="avgUse" class="stat-avg">Avg: 0.0/day</p>
            </div>
            <div class="glass-card">
                <p class="text-[9px] font-bold text-gray-400 uppercase">Self Sufficiency</p>
                <p id="effPercent" class="stat-val text-green-600">0%</p>
                <p class="stat-avg">Utilization</p>
            </div>
            <div class="glass-card">
                <p class="text-[9px] font-bold text-gray-400 uppercase">CO2 Offset</p>
                <p id="co2Stat" class="stat-val text-blue-600">0.0 <span class="text-[10px]">kg</span></p>
                <p class="stat-avg">Carbon Saved</p>
            </div>
        </div>

        <div class="glass-card bg-green-50 border-green-200 py-3">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-[10px] text-green-700 font-bold uppercase">Banking Balance (Export-Import)</p>
                    <p id="statBanking" class="text-2xl font-black text-green-800">0.0 <span class="text-xs">Units</span></p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-green-700 font-bold uppercase">Estimated Value</p>
                    <p id="statAmount" class="text-lg font-bold text-green-600">₹ 0.00</p>
                </div>
            </div>
        </div>

        <div class="glass-card">
            <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Performance History</p>
            <div style="height: 160px;"><canvas id="lineChart"></canvas></div>
            <div class="flex justify-center gap-4 mt-3 border-t pt-2">
                <div class="legend-item"><div class="legend-color bg-blue-500"></div><span class="text-blue-600 uppercase">Prod</span></div>
                <div class="legend-item"><div class="legend-color bg-orange-500"></div><span class="text-orange-600 uppercase">Usage</span></div>
            </div>
        </div>

        <div class="glass-card">
            <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">Today's Split (Units)</p>
            <div class="flex items-center justify-around py-1">
                <div style="width: 100px; height: 100px;">
                    <canvas id="roundChart"></canvas>
                </div>
                <div class="space-y-1.5">
                    <div class="legend-item"><div class="legend-color bg-blue-400"></div><span>PROD: <span id="splitProd" class="font-bold">0</span></span></div>
                    <div class="legend-item"><div class="legend-color bg-orange-400"></div><span>USE: <span id="splitUse" class="font-bold">0</span></span></div>
                    <div class="legend-item"><div class="legend-color bg-red-400"></div><span>IMP: <span id="splitImp" class="font-bold">0</span></span></div>
                </div>
            </div>
        </div>

        <div id="inputSection" class="glass-card border-t-4 border-green-500">
            <p class="text-[11px] font-bold text-gray-700 mb-3 uppercase tracking-wider">Meter Reading Input</p>
            <div class="space-y-3">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 ml-1 uppercase">Date</label>
                    <input type="date" id="inputDate" class="input-box">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-500 ml-1 uppercase">Production Meter Reading</label>
                    <input type="number" id="prodReading" class="input-box" placeholder="0.0">
                    <p id="prevProd" class="text-[9px] text-blue-500 mt-1 font-medium">Prev: --</p>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 ml-1 uppercase">KSEB Export Meter</label>
                        <input type="number" id="exportReading" class="input-box" placeholder="0.0">
                        <p id="prevExport" class="text-[9px] text-green-600 mt-1 font-medium">Prev: --</p>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 ml-1 uppercase">KSEB Import Meter</label>
                        <input type="number" id="importReading" class="input-box" placeholder="0.0">
                        <p id="prevImport" class="text-[9px] text-red-500 mt-1 font-medium">Prev: --</p>
                    </div>
                </div>
            </div>
            <button onclick="saveData()" class="w-full bg-green-600 text-white font-bold py-3 mt-4 rounded-lg shadow-md active:scale-95 transition uppercase text-xs">
                Save Reading
            </button>
        </div>

        <div class="flex justify-center pb-6">
            <button onclick="showModal()" class="text-[9px] text-red-300 font-bold uppercase tracking-widest">
                <i class="fas fa-trash mr-1"></i> Reset All Data
            </button>
        </div>
    </div>

    <button onclick="document.getElementById('inputSection').scrollIntoView()" class="fab">
        <i class="fas fa-plus"></i>
    </button>

    <div id="resetModal">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-[280px] text-center">
            <h3 class="font-bold text-gray-800 text-base mb-2">ഡാറ്റ മുഴുവൻ കളയണോ?</h3>
            <p class="text-[11px] text-gray-500 mb-6">സേവ് ചെയ്ത വിവരങ്ങൾ എല്ലാം മാഞ്ഞുപോകും.</p>
            <div class="flex gap-2">
                <button onclick="hideModal()" class="flex-1 bg-gray-100 py-2.5 rounded-xl font-bold text-xs uppercase">No</button>
                <button onclick="resetData()" class="flex-1 bg-red-500 text-white py-2.5 rounded-xl font-bold text-xs uppercase">Yes</button>
            </div>
        </div>
    </div>

    <footer> POWERED BY VTSOFT 2026 </footer>

    <script>
        document.getElementById('inputDate').valueAsDate = new Date();
        let solarData = JSON.parse(localStorage.getItem('solarData')) || [];
        let lineChart = null;
        let roundChart = null;

        function init() {
            displayPrevious();
            calculateAll();
            renderCharts();
        }

        function displayPrevious() {
            if (solarData.length > 0) {
                const last = solarData[solarData.length - 1];
                document.getElementById('prevProd').innerText = "Prev: " + last.prod;
                document.getElementById('prevExport').innerText = "Prev: " + last.exp;
                document.getElementById('prevImport').innerText = "Prev: " + last.imp;
                
                // Set Last Updated Date in Header
                const d = new Date(last.date);
                document.getElementById('lastUpdateText').innerText = "Last Updated: " + d.toLocaleDateString('en-GB');
            }
        }

        function saveData() {
            const entry = {
                date: document.getElementById('inputDate').value,
                prod: parseFloat(document.getElementById('prodReading').value) || 0,
                exp: parseFloat(document.getElementById('exportReading').value) || 0,
                imp: parseFloat(document.getElementById('importReading').value) || 0
            };
            
            if(!entry.prod) return alert("റീഡിംഗ് നൽകുക!");
            
            if (solarData.length > 0) {
                const last = solarData[solarData.length - 1];
                if (entry.prod < last.prod || entry.exp < last.exp || entry.imp < last.imp) {
                    return alert("New reading must be greater than or equal to previous reading!");
                }
            }

            const index = solarData.findIndex(d => d.date === entry.date);
            if (index > -1) solarData[index] = entry;
            else solarData.push(entry);

            solarData.sort((a, b) => new Date(a.date) - new Date(b.date));
            localStorage.setItem('solarData', JSON.stringify(solarData));
            location.reload(); 
        }

        function getDiffDays(d1, d2) {
            const dt1 = new Date(d1);
            const dt2 = new Date(d2);
            return Math.ceil(Math.abs(dt2 - dt1) / (1000 * 60 * 60 * 24));
        }

        function calculateAll() {
            if (solarData.length < 1) return;
            
            const last = solarData[solarData.length - 1];
            
            // Display Total Production
            document.getElementById('totalProd').innerText = last.prod.toFixed(1);
            
            // Display Banking Balance and Value
            document.getElementById('statBanking').innerText = (last.exp - last.imp).toFixed(1);
            document.getElementById('statAmount').innerText = "₹ " + ((last.exp - last.imp) * 3.15).toFixed(2);

            if (solarData.length >= 2) {
                const first = solarData[0];
                const totalDays = getDiffDays(first.date, last.date);
                
                if (totalDays > 0) {
                    const diffProd = last.prod - first.prod;
                    const diffExp = last.exp - first.exp;
                    const diffImp = last.imp - first.imp;
                    
                    // CORRECTED: Total Home Usage = Total Production - Export + Import
                    const totalUsage = diffProd - diffExp + diffImp;
                    
                    // Calculate averages
                    document.getElementById('avgProd').innerText = "Avg: " + (diffProd / totalDays).toFixed(1) + "/day";
                    document.getElementById('totalUse').innerText = totalUsage.toFixed(1);
                    document.getElementById('avgUse').innerText = "Avg: " + (totalUsage / totalDays).toFixed(1) + "/day";
                    
                    // Efficiency Percentage (Self Consumption)
                    if (diffProd > 0) {
                        const selfConsumed = diffProd - diffExp;
                        document.getElementById('effPercent').innerText = 
                            Math.max(0, (selfConsumed / diffProd) * 100).toFixed(0) + "%";
                    } else {
                        document.getElementById('effPercent').innerText = "0%";
                    }
                    
                    // CO2 Savings
                    document.getElementById('co2Stat').innerText = (diffProd * 0.7).toFixed(1);
                    
                    // Calculate TODAY'S breakdown (from last 2 entries)
                    const prev = solarData[solarData.length - 2];
                    const daysBetween = getDiffDays(prev.date, last.date);
                    
                    if (daysBetween > 0) {
                        const todayProd = (last.prod - prev.prod) / daysBetween;
                        const todayExp = (last.exp - prev.exp) / daysBetween;
                        const todayImp = (last.imp - prev.imp) / daysBetween;
                        
                        // Today's Home Usage = Today's Production - Today's Export + Today's Import
                        const todayUsage = todayProd - todayExp + todayImp;
                        
                        // Today's breakdown: Solar Usage + Grid Import
                        const solarUsage = todayProd - todayExp; // Solar energy directly used
                        const gridUsage = todayImp; // Energy imported from grid
                        
                        // ✅ PRODUCTION BOX-ൽ ഇന്നത്തെ production കാണിക്കുക
                        document.getElementById('todayProdText').innerText = 
                            "Today: " + todayProd.toFixed(1) + " units";
                        
                        // Update Today's Usage Breakdown
                        document.getElementById('todayUsageBreakdown').innerHTML = 
                            `<span class="solar-use">Solar: ${solarUsage.toFixed(1)}</span> | ` +
                            `<span class="grid-use">Grid: ${gridUsage.toFixed(1)}</span>`;
                    }
                }
            }
        }

        function renderCharts() {
            if (solarData.length < 2) return;
            
            // --- Line Chart Logic (with Gap Filling) ---
            let labels = []; let pData = []; let uData = [];
            for (let i = 1; i < solarData.length; i++) {
                let d1 = new Date(solarData[i-1].date);
                let daysSpan = getDiffDays(solarData[i-1].date, solarData[i].date);
                if(daysSpan === 0) continue;

                let dp = (solarData[i].prod - solarData[i-1].prod) / daysSpan;
                // CORRECTED: Daily Usage = Daily Production - Daily Export + Daily Import
                let du = ((solarData[i].prod - solarData[i-1].prod) - 
                         (solarData[i].exp - solarData[i-1].exp) + 
                         (solarData[i].imp - solarData[i-1].imp)) / daysSpan;

                for (let j = 1; j <= daysSpan; j++) {
                    let nextDate = new Date(d1); nextDate.setDate(d1.getDate() + j);
                    labels.push(nextDate.toLocaleDateString('en-GB', {day:'2-digit', month:'2-digit'}));
                    pData.push(dp.toFixed(2)); uData.push(du.toFixed(2));
                }
            }
            
            const ctxLine = document.getElementById('lineChart').getContext('2d');
            if (lineChart) lineChart.destroy();
            
            lineChart = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labels.slice(-15),
                    datasets: [
                        { 
                            label: 'Prod', 
                            data: pData.slice(-15), 
                            borderColor: '#3b82f6', 
                            tension: 0.3, 
                            borderWidth: 2, 
                            pointRadius: 2, 
                            fill: false 
                        },
                        { 
                            label: 'Use', 
                            data: uData.slice(-15), 
                            borderColor: '#f97316', 
                            tension: 0.3, 
                            borderWidth: 2, 
                            pointRadius: 2, 
                            fill: false 
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // --- Round Chart (Today's Split) Logic ---
            const last = solarData[solarData.length-1];
            const prev = solarData[solarData.length-2];
            const dSpan = getDiffDays(prev.date, last.date);
            
            if (dSpan <= 0) return;
            
            const dp = (last.prod - prev.prod) / dSpan;
            const de = (last.exp - prev.exp) / dSpan;
            const di = (last.imp - prev.imp) / dSpan;
            const du = dp - de + di; // CORRECTED: Today's Usage

            document.getElementById('splitProd').innerText = dp.toFixed(1);
            document.getElementById('splitUse').innerText = du.toFixed(1);
            document.getElementById('splitImp').innerText = di.toFixed(1);

            const ctxRound = document.getElementById('roundChart').getContext('2d');
            if (roundChart) roundChart.destroy();
            
            roundChart = new Chart(ctxRound, {
                type: 'doughnut',
                data: {
                    labels: ['Production', 'Usage', 'Import'],
                    datasets: [{
                        data: [dp.toFixed(1), du.toFixed(1), di.toFixed(1)],
                        backgroundColor: ['#60a5fa', '#fb923c', '#f87171'],
                        borderWidth: 1
                    }]
                },
                options: { 
                    cutout: '65%', 
                    plugins: { legend: { display: false } }
                }
            });
        }

        function showModal() { 
            document.getElementById('resetModal').style.display = 'flex'; 
        }
        
        function hideModal() { 
            document.getElementById('resetModal').style.display = 'none'; 
        }
        
        function resetData() { 
            localStorage.removeItem("solarData"); 
            location.reload(); 
        }

        init();
    </script>
</body>
</html>