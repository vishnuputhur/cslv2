<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-21G1BS7S3S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-21G1BS7S3S');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Register 2025-2026</title>
    <style>
        body {
            background-color: #1E3A5F;
            font-family: 'Poppins', sans-serif;
            color: #F5E6C4;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .top-img {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            cursor: pointer;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 99;
        }

        .sub-title {
            font-size: 18px;
            margin-top: 60px;
            font-weight: bold;
            font-family: 'Times New Roman', serif;
            color: #ffffff;
        }

        .container {
            background-color: #F5E6C4;
            color: #1E3A5F;
            width: 87%;
            max-width: 350px;
            padding: 15px;
            margin: 5px auto;
            border-radius: 8px;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.3);
            flex-grow: 1;
        }

        .tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }

        .tab-btn {
            width: 45%;
            padding: 8px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            color: white;
            background-color: #1E3A5F;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
        }

        .tab-btn.active {
            background-color: #8B1E3F;
        }

        .month-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: #1E3A5F;
            color: white;
            border-radius: 5px;
            position: sticky;
            top: 150px;
            z-index: 900;
            font-size: 14px;
        }

        .month-nav-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0 10px;
        }

        .week-header {
            display: flex;
            background: #e0e0e0;
            padding: 5px;
            font-weight: bold;
            position: sticky;
            top: 190px;
            z-index: 800;
            font-size: 12px;
        }

        .week-header div, .day {
            width: 14%;
            text-align: center;
        }

        .week {
            display: flex;
        }

        .day {
            padding: 8px;
            border: 1px solid #ddd;
            margin: 1px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            position: relative;
        }

        .day.holiday {
            color: red;
        }

        .day.today {
            border: 2px solid blue;
            border-radius: 50%;
            box-sizing: border-box;
        }

        .day.present-in {
            background: #FFFF99 !important;
            color: black;
        }

        .day.present-full {
            background: #90EE90 !important;
            color: black;
        }

        .leave-cl {
            background: #ADD8E6 !important;
            color: white;
        }

        .leave-el {
            background: #C04070 !important;
            color: white;
        }

        .leave-hpl {
            background: #FFA07A !important;
            color: white;
        }

        .leave-special {
            background: #FFC0CB !important;
            color: white;
        }

        .half-day-cl {
            background: linear-gradient(to right, #90EE90 50%, #ADD8E6 50%) !important;
            color: white;
        }

        .half-day-el {
            background: linear-gradient(to right, #90EE90 50%, #C04070 50%) !important;
            color: white;
        }

        .half-day-hpl {
            background: linear-gradient(to right, #90EE90 50%, #FFA07A 50%) !important;
            color: white;
        }

        .half-day-special {
            background: linear-gradient(to right, #90EE90 50%, #FFC0CB 50%) !important;
            color: white;
        }

        .day.present-in.holiday, .day.present-full.holiday {
            color: red;
        }

        .ot-display {
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 8px;
            color: #1E3A5F;
            font-weight: normal;
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #F5E6C4;
            color: #1E3A5F;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
            z-index: 2000;
            width: 90%;
            max-width: 300px;
            font-size: 12px;
        }

        .popup label {
            display: inline;
            margin-right: 5px;
            font-weight: bold;
            color: #1E3A5F;
            width: 50px;
            text-align: right;
        }

        .settings-row {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }

        .settings-row label {
            margin-right: 5px;
            font-weight: bold;
            color: #1E3A5F;
            font-size: 12px;
            width: 50px;
            text-align: right;
        }

        .settings-row input, .settings-row select {
            width: 120px;
            padding: 5px;
            font-size: 12px;
            margin: 0;
            border: 1px solid #1E3A5F;
            border-radius: 4px;
            background: #FAF8E3;
        }

        .btn {
            padding: 8px;
            margin: 5px;
            font-size: 12px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            color: white;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.4);
        }

        .save-btn {
            background-color: #1E3A5F;
        }

        .clear-btn {
            background-color: #8B1E3F;
        }

        .result {
            margin-top: 10px;
            font-size: 12px;
            color: #1E3A5F;
            background: #FAF8E3;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.15);
        }

        .footer {
            font-size: 14px;
            padding: 4.5px;
            background-color: #0F2A44;
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 0;
            z-index: 100;
        }

        .bottom-padding {
            height: 18px;
        }

        .leave-msg {
            color: red;
            font-size: 10px;
            margin: 5px 0;
        }

        .ot-remaining {
            color: red;
            font-size: 10px;
        }
    </style>
</head>
<body onload="initApp()">
    <a href="index.html">
        <img src="https://i.ibb.co/BYPxNBB/Screenshot-20250529-141452-CSL-Calculations.jpg" alt="Top Image" class="top-img">
    </a>

    <div class="sub-title">Attendance Register 2025-2026</div>

    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('calendar')">Calendar</button>
            <button class="tab-btn" onclick="showTab('settings')">Settings</button>
        </div>

        <div id="calendar-tab">
            <div class="calendar-container" id="calendar-container"></div>
            <button class="btn save-btn" onclick="generateMonthlyPDF()">Monthly Details PDF</button>
            <div class="result" id="summary-box"></div>
        </div>

        <div id="settings-tab" style="display: none;">
            <form id="settingsForm">
                <div class="settings-row">
                    <label for="empName">Name:</label>
                    <input type="text" id="empName" required>
                </div>
                <div class="settings-row">
                    <label for="empCode">Code:</label>
                    <input type="text" id="empCode" required>
                </div>
                <div class="settings-row">
                    <label for="clBalance">CL:</label>
                    <input type="number" id="clBalance" step="0.5" required>
                </div>
                <div class="settings-row">
                    <label for="elBalance">EL:</label>
                    <input type="number" id="elBalance" step="0.5" required>
                </div>
                <div class="settings-row">
                    <label for="hplBalance">HPL:</label>
                    <input type="number" id="hplBalance" step="0.5" required>
                </div>
                <div class="settings-row">
                    <label for="specialLeave">Special:</label>
                    <input type="number" id="specialLeave" max="3" required>
                </div>
                <div>
                    <button type="button" class="btn save-btn" onclick="saveSettings()">Save</button>
                    <button type="reset" class="btn clear-btn">Clear</button>
                </div>
            </form>
        </div>
    </div>

    <div class="popup" id="attendance-popup"></div>
    <div class="bottom-padding"></div>
    <div class="footer">Powered by VT@Soft © 2026 | Version 2.8</div>

    <script>
        // 2025 ഹോളിഡേകൾ
        const holidays2025 = {
            "2025-08-15": "Independence Day",
            "2025-09-04": "First Onam",
            "2025-09-05": "Thiruvonam",
            "2025-09-06": "Third Onam",
            "2025-10-02": "Gandhi Jayanthi / Vijayadasami",
            "2025-10-20": "Deepavali",
            "2025-12-25": "Christmas"
        };

        // 2026 ഹോളിഡേകൾ
        const holidays2026 = {
            "2026-01-26": "Republic Day",
            "2026-03-20": "Id-ul-Fitr (Ramzan)",
            "2026-04-03": "Good Friday",
            "2026-04-15": "Vishu",
            "2026-05-01": "May Day",
            "2026-05-27": "Id-ul-Ad'ha (Bakrid)",
            "2026-08-15": "Independence Day",
            "2026-08-26": "Thiruvonam",
            "2026-08-28": "Fourth Onam Sree Narayana Ayyankali Jayanthi",
            "2026-10-02": "Gandhi Jayanthi",
            "2026-10-21": "Vijayadasami",
            "2026-12-25": "Christmas"
        };

        // 2nd & 4th സാറ്റർഡേകൾ കണക്കാക്കുന്ന ഫംഗ്ഷൻ
        function getWeekendDates(year) {
            const weekends = [];
            for (let month = 0; month < 12; month++) {
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                let secondSat = null;
                let fourthSat = null;
                let satCount = 0;
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    if (date.getDay() === 6) { // Saturday
                        satCount++;
                        if (satCount === 2) secondSat = day;
                        if (satCount === 4) fourthSat = day;
                    }
                }
                
                if (secondSat) {
                    weekends.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(secondSat).padStart(2, '0')}`);
                }
                if (fourthSat) {
                    weekends.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(fourthSat).padStart(2, '0')}`);
                }
            }
            return weekends;
        }

        const weekends2025 = getWeekendDates(2025);
        const weekends2026 = getWeekendDates(2026);

        const shiftTimes = {
            "A2": { start: "07:00", end: "15:20", grace: "07:05" },
            "B2": { start: "13:40", end: "22:00", grace: "13:45" },
            "C2": { start: "06:00", end: "14:00", grace: "06:05" },
            "C1": { start: "08:00", end: "16:20", grace: "08:05" }
        };

        const today = new Date();
        let currentYear = today.getFullYear();
        let currentMonth = today.getMonth();
        let attendanceData = JSON.parse(localStorage.getItem('attendanceData')) || {};
        let employeeData = JSON.parse(localStorage.getItem('employeeData')) || {
            name: '', code: '', cl: 0, el: 0, hpl: 0, special: 3, elBaseMonth: today.getMonth(), settingsUpdated: false
        };

        function initApp() {
            // Current date automatically load ചെയ്യും
            loadSettings();
            showMonth(currentMonth);
        }

        function getHolidaysForYear(year) {
            return year === 2025 ? holidays2025 : holidays2026;
        }

        function getWeekendsForYear(year) {
            return year === 2025 ? weekends2025 : weekends2026;
        }

        function isHoliday(dateStr, dayOfWeek, date) {
            if (dayOfWeek === 0) return true; // Sunday
            const holidays = getHolidaysForYear(currentYear);
            const weekends = getWeekendsForYear(currentYear);
            return holidays[dateStr] || weekends.includes(dateStr);
        }

        function formatTimeFromHours(decimalHours) {
            if (!decimalHours) return '';
            const hours = Math.floor(decimalHours);
            const minutes = Math.round((decimalHours - hours) * 60);
            return `${hours}.${String(minutes).padStart(2, '0')}`;
        }

        function parseTimeToHours(timeStr) {
            if (!timeStr) return 0;
            timeStr = timeStr.replace(':', '.');
            const [hours, minutes] = timeStr.split('.').map(Number);
            return hours + (minutes / 60 || 0);
        }

        function showMonth(month) {
            // Year change automatically when navigating between 2025-2026
            let newYear = currentYear;
            let newMonth = month;
            
            // Handle year transitions
            if (month < 0) {
                newMonth = 11;
                newYear = currentYear - 1;
            } else if (month > 11) {
                newMonth = 0;
                newYear = currentYear + 1;
            } else {
                newMonth = month;
            }
            
            // Only allow 2025 and 2026
            if (newYear < 2025) newYear = 2025;
            if (newYear > 2026) newYear = 2026;
            
            currentYear = newYear;
            currentMonth = newMonth;
            
            // EL ബാലൻസ് update ചെയ്യുക (2025ൽ മാത്രം)
            if (currentYear === 2025) {
                const monthsElapsed = currentMonth - employeeData.elBaseMonth;
                if (monthsElapsed > 0) {
                    employeeData.el = (employeeData.el || 0) + (monthsElapsed * 2.5);
                    employeeData.elBaseMonth = currentMonth;
                    localStorage.setItem('employeeData', JSON.stringify(employeeData));
                    loadSettings();
                }
            }
            
            let calendarHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthName = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' });

            calendarHTML += `
                <div class="month-container" id="month-${currentMonth}">
                    <button class="month-nav-btn" onclick="showMonth(currentMonth - 1)">&larr;</button>
                    <span>${monthName} ${currentYear}</span>
                    <button class="month-nav-btn" onclick="showMonth(currentMonth + 1)">&rarr;</button>
                </div>
                <div class="week-header">
                    <div>Sun</div><div>Mon</div><div>Tue</div>
                    <div>Wed</div><div>Thu</div><div>Fri</div>
                    <div>Sat</div>
                </div>
            `;

            let date = 1;
            for (let i = 0; i < 6; i++) {
                if (date > daysInMonth) break;
                calendarHTML += `<div class="week">`;
                for (let j = 0; j < 7; j++) {
                    if ((i === 0 && j < firstDay) || date > daysInMonth) {
                        calendarHTML += '<div class="day"></div>';
                    } else {
                        const currentDate = new Date(currentYear, currentMonth, date);
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                        let classes = 'day';
                        if (isHoliday(dateStr, j, currentDate)) classes += ' holiday';
                        if (today.getFullYear() === currentYear && today.getMonth() === currentMonth && today.getDate() === date) {
                            classes += ' today';
                        }
                        if (attendanceData[dateStr]) {
                            if (attendanceData[dateStr].leave) {
                                const leaveType = attendanceData[dateStr].leave.toLowerCase();
                                if (attendanceData[dateStr].halfDay === 'Yes') {
                                    classes += ` half-day half-day-${leaveType}`;
                                } else {
                                    classes += ` leave leave-${leaveType}`;
                                }
                            } else if (attendanceData[dateStr].inPunch && attendanceData[dateStr].outPunch) {
                                classes += ' present-full';
                            } else if (attendanceData[dateStr].inPunch) {
                                classes += ' present-in';
                            }
                        }
                        const otDisplay = attendanceData[dateStr]?.ot && attendanceData[dateStr].ot != 0 ? `<span class="ot-display">${formatTimeFromHours(attendanceData[dateStr].ot)}h</span>` : '';
                        calendarHTML += `<div class="${classes}" onclick="showAttendancePopup('${dateStr}')">${date}${otDisplay}</div>`;
                        date++;
                    }
                }
                calendarHTML += '</div>';
            }
            document.getElementById('calendar-container').innerHTML = calendarHTML;
            updateSummaryBox();
            window.scrollTo({ top: document.getElementById('calendar-container').offsetTop - 130, behavior: 'smooth' });
        }

        function updateSummaryBox() {
            let totalOT = 0, quarterlyOT = 0, clTaken = 0, elTaken = 0, hplTaken = 0, specialTaken = 0, presentDays = 0;
            
            // Calculate quarter based on current month
            let quarter;
            if (currentMonth >= 0 && currentMonth <= 2) quarter = 1;
            else if (currentMonth >= 3 && currentMonth <= 5) quarter = 2;
            else if (currentMonth >= 6 && currentMonth <= 8) quarter = 3;
            else quarter = 4;
            
            const quarterStartMonth = (quarter - 1) * 3;
            const quarterEndMonth = quarterStartMonth + 2;
            const quarterStart = new Date(currentYear, quarterStartMonth, 20);
            const quarterEnd = new Date(currentYear, quarterEndMonth + 1, 20);

            for (let dateStr in attendanceData) {
                const date = new Date(dateStr);
                
                // Current month statistics
                if (date.getFullYear() === currentYear && date.getMonth() === currentMonth) {
                    if (attendanceData[dateStr].leave) {
                        const deduction = attendanceData[dateStr].halfDay === 'Yes' ? 0.5 : 1;
                        if (attendanceData[dateStr].leave === 'CL') clTaken += deduction;
                        else if (attendanceData[dateStr].leave === 'EL') elTaken += deduction;
                        else if (attendanceData[dateStr].leave === 'HPL') hplTaken += deduction * 2;
                        else if (attendanceData[dateStr].leave === 'Special') specialTaken += deduction;
                    } else if (attendanceData[dateStr].inPunch && attendanceData[dateStr].outPunch) {
                        presentDays += 1;
                    }
                    if (attendanceData[dateStr].ot) totalOT += parseFloat(attendanceData[dateStr].ot);
                }
                
                // Quarterly calculation
                if (date >= quarterStart && date < quarterEnd) {
                    if (attendanceData[dateStr].ot) quarterlyOT += parseFloat(attendanceData[dateStr].ot);
                }
            }
            
            const otRemaining = 75 - quarterlyOT;
            const otRemainingDisplay = otRemaining >= 0 ? `(-${otRemaining.toFixed(2)}hr)` : `(+${Math.abs(otRemaining).toFixed(2)}hr)`;
            
            let summaryHTML = `
                <p>Total OT: ${formatTimeFromHours(totalOT)} hrs</p>
                <p>Quarterly OT: ${formatTimeFromHours(quarterlyOT)} hrs <span class="ot-remaining">${otRemainingDisplay}</span></p>
                <p>CL: ${employeeData.cl.toFixed(1)} (${clTaken.toFixed(1)})</p>
                <p>EL: ${employeeData.el.toFixed(1)} (${elTaken.toFixed(1)})</p>
                <p>HPL: ${employeeData.hpl.toFixed(1)} (${hplTaken.toFixed(1)})</p>
                <p>Special: ${employeeData.special} (${specialTaken})</p>
                <p>Total Present Days: ${presentDays}</p>
            `;
            
            document.getElementById('summary-box').innerHTML = summaryHTML;
        }

        function applyHolidayLeaveRule() {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const prevDate = new Date(currentYear, currentMonth, d - 1);
                const nextDate = new Date(currentYear, currentMonth, d + 1);
                const prevDateStr = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}-${String(prevDate.getDate()).padStart(2, '0')}`;
                const nextDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
                
                if (isHoliday(dateStr) && attendanceData[prevDateStr] && attendanceData[nextDateStr]) {
                    const prevData = attendanceData[prevDateStr];
                    const nextData = attendanceData[nextDateStr];
                    if (prevData.leave === nextData.leave && (prevData.leave === 'EL' || prevData.leave === 'HPL') && prevData.halfDay !== 'Yes' && nextData.halfDay !== 'Yes') {
                        attendanceData[dateStr] = { ...attendanceData[dateStr], leave: prevData.leave, halfDay: 'No' };
                    }
                }
            }
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
        }

        function showAttendancePopup(dateStr) {
            const data = attendanceData[dateStr] || {};
            const defaultTimes = shiftTimes[data.shift] || { start: '', end: '' };
            let popupHTML = `
                <h3 style="font-size: 14px; margin: 5px 0;">${dateStr}</h3>
                <div class="settings-row">
                    <label for="shift">Shift:</label>
                    <select id="shift" onchange="setDefaultTimes()">
                        <option value="" ${!data.shift ? 'selected' : ''}>None</option>
                        <option value="A2" ${data.shift === 'A2' ? 'selected' : ''}>A2</option>
                        <option value="B2" ${data.shift === 'B2' ? 'selected' : ''}>B2</option>
                        <option value="C2" ${data.shift === 'C2' ? 'selected' : ''}>C2</option>
                        <option value="C1" ${data.shift === 'C1' ? 'selected' : ''}>C1</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label for="inPunch">In:</label>
                    <input type="time" id="inPunch" value="${data.inPunch || defaultTimes.start}">
                </div>
                <div class="settings-row">
                    <label for="outPunch">Out:</label>
                    <input type="time" id="outPunch" value="${data.outPunch || defaultTimes.end}">
                </div>
                <div class="settings-row">
                    <label for="ot">OT:</label>
                    <input type="text" id="ot" value="${formatTimeFromHours(data.ot)}" placeholder="H:MM">
                </div>
                <div class="settings-row">
                    <label for="leave">Leave:</label>
                    <select id="leave" onchange="updateHalfDayOptions()">
                        <option value="" ${!data.leave ? 'selected' : ''}>None</option>
                        <option value="CL" ${data.leave === 'CL' ? 'selected' : ''} ${employeeData.cl <= 0 ? 'disabled' : ''}>CL</option>
                        <option value="EL" ${data.leave === 'EL' ? 'selected' : ''} ${employeeData.el <= 0 ? 'disabled' : ''}>EL</option>
                        <option value="HPL" ${data.leave === 'HPL' ? 'selected' : ''} ${employeeData.hpl <= 0 ? 'disabled' : ''}>HPL</option>
                        <option value="Special" ${data.leave === 'Special' ? 'selected' : ''} ${employeeData.special <= 0 ? 'disabled' : ''}>Special</option>
                    </select>
                </div>
                <div class="settings-row">
                    <label for="halfDay">Half Day:</label>
                    <select id="halfDay">
                        <option value="No" ${data.halfDay !== 'Yes' ? 'selected' : ''}>No</option>
                        <option value="Yes" ${data.halfDay === 'Yes' ? 'selected' : ''}>Yes</option>
                    </select>
                </div>
            `;
            if (!employeeData.settingsUpdated) {
                popupHTML += `<p class="leave-msg">Please update leave balance in settings tab</p>`;
            }
            popupHTML += `
                <div>
                    <button class="btn save-btn" onclick="saveAttendance('${dateStr}')">Save</button>
                    <button class="btn clear-btn" onclick="document.getElementById('attendance-popup').style.display='none'">Close</button>
                </div>
            `;
            document.getElementById('attendance-popup').innerHTML = popupHTML;
            document.getElementById('attendance-popup').style.display = 'block';
            updateHalfDayOptions();
        }

        function updateHalfDayOptions() {
            const leave = document.getElementById('leave').value;
            const halfDaySelect = document.getElementById('halfDay');
            if (leave === 'EL' || leave === 'Special') {
                halfDaySelect.value = 'No';
                halfDaySelect.disabled = true;
            } else {
                halfDaySelect.disabled = false;
            }
        }

        function setDefaultTimes() {
            const shift = document.getElementById('shift').value;
            const inPunch = document.getElementById('inPunch');
            const outPunch = document.getElementById('outPunch');
            if (shift && shiftTimes[shift]) {
                inPunch.value = inPunch.value || shiftTimes[shift].start;
                outPunch.value = outPunch.value || shiftTimes[shift].end;
            } else {
                if (!inPunch.value) inPunch.value = '';
                if (!outPunch.value) outPunch.value = '';
            }
        }

        function saveAttendance(dateStr) {
            const inPunch = document.getElementById('inPunch').value;
            const outPunch = document.getElementById('outPunch').value;
            const ot = parseTimeToHours(document.getElementById('ot').value);
            const leave = document.getElementById('leave').value;
            const halfDay = document.getElementById('halfDay').value;
            const shift = document.getElementById('shift').value;

            // Revert previous leave deduction if it exists
            if (attendanceData[dateStr]?.leave) {
                const prevDeduction = attendanceData[dateStr].halfDay === 'Yes' ? 0.5 : 1;
                const prevLeave = attendanceData[dateStr].leave;
                if (prevLeave === 'CL') employeeData.cl += prevDeduction;
                else if (prevLeave === 'EL') employeeData.el += prevDeduction;
                else if (prevLeave === 'HPL') employeeData.hpl += prevDeduction * 2;
                else if (prevLeave === 'Special') employeeData.special += prevDeduction;
            }

            // Apply new leave deduction
            if (leave && (!attendanceData[dateStr]?.leave || attendanceData[dateStr].leave !== leave || attendanceData[dateStr].halfDay !== halfDay)) {
                let deduction = halfDay === 'Yes' ? 0.5 : 1;
                if (leave === 'HPL') deduction *= 2;
                if (leave === 'CL' && employeeData.cl >= deduction) employeeData.cl -= deduction;
                else if (leave === 'EL' && employeeData.el >= deduction) employeeData.el -= deduction;
                else if (leave === 'HPL' && employeeData.hpl >= deduction) employeeData.hpl -= deduction;
                else if (leave === 'Special' && employeeData.special >= deduction) employeeData.special -= deduction;
            }

            attendanceData[dateStr] = { inPunch, outPunch, ot, leave, halfDay, shift };
            localStorage.setItem('attendanceData', JSON.stringify(attendanceData));
            localStorage.setItem('employeeData', JSON.stringify(employeeData));
            document.getElementById('attendance-popup').style.display = 'none';
            applyHolidayLeaveRule();
            showMonth(currentMonth);
        }

        function showTab(tab) {
            document.getElementById('calendar-tab').style.display = tab === 'calendar' ? 'block' : 'none';
            document.getElementById('settings-tab').style.display = tab === 'settings' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="showTab('${tab}')"]`).classList.add('active');
        }

        function saveSettings() {
            employeeData.name = document.getElementById('empName').value;
            employeeData.code = document.getElementById('empCode').value;
            employeeData.cl = parseFloat(document.getElementById('clBalance').value);
            employeeData.el = parseFloat(document.getElementById('elBalance').value);
            employeeData.hpl = parseFloat(document.getElementById('hplBalance').value);
            employeeData.special = parseInt(document.getElementById('specialLeave').value);
            employeeData.elBaseMonth = currentMonth;
            employeeData.settingsUpdated = true;
            localStorage.setItem('employeeData', JSON.stringify(employeeData));
            alert('Settings saved!');
            loadSettings();
        }

        function loadSettings() {
            document.getElementById('empName').value = employeeData.name || '';
            document.getElementById('empCode').value = employeeData.code || '';
            document.getElementById('clBalance').value = (employeeData.cl || 0).toFixed(1);
            document.getElementById('elBalance').value = (employeeData.el || 0).toFixed(1);
            document.getElementById('hplBalance').value = (employeeData.hpl || 0).toFixed(1);
            document.getElementById('specialLeave').value = employeeData.special || 3;
        }

        function generateMonthlyPDF() {
            try {
                const monthName = new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' });
                let tableData = [];
                let totalLeave = 0, totalOT = 0, totalPresent = 0;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const data = attendanceData[dateStr] || {};
                    const dateObj = new Date(currentYear, currentMonth, d);
                    const isHol = isHoliday(dateStr, dateObj.getDay(), dateObj);
                    const leaveStr = data.leave ? `${data.leave}${data.halfDay === 'Yes' ? ' (Half)' : ''}` : (isHol ? 'Holiday' : '');
                    const leaveType = data.leave ? data.leave.toLowerCase() : '';

                    if (data.leave) {
                        const deduction = data.halfDay === 'Yes' ? 0.5 : 1;
                        totalLeave += deduction;
                    } else if (data.inPunch && data.outPunch && !isHol) {
                        totalPresent += 1;
                    }
                    if (data.ot) totalOT += parseFloat(data.ot);

                    tableData.push({
                        date: dateStr,
                        shift: data.shift || '',
                        inTime: data.inPunch || '',
                        outTime: data.outPunch || '',
                        leave: leaveStr,
                        ot: data.ot ? `${formatTimeFromHours(data.ot)} hrs` : '0',
                        isHoliday: isHol,
                        leaveType: leaveType
                    });
                }

                const pdfData = {
                    name: employeeData.name || 'Unknown',
                    code: employeeData.code || 'Unknown',
                    month: `${monthName} ${currentYear}`,
                    table: tableData,
                    totalLeave: totalLeave.toFixed(1),
                    totalOT: formatTimeFromHours(totalOT),
                    totalPresent: totalPresent
                };

                const encodedData = encodeURIComponent(JSON.stringify(pdfData));
                const redirectUrl = `openchrome://vishnuputhur.github.io/cslv2/atnpdf.html?data=${encodedData}`;
                
                console.log('Triggering Chrome with URL:', redirectUrl);
                window.location.href = redirectUrl;
            } catch (error) {
                console.error('Error in generateMonthlyPDF:', error);
                alert('Failed to generate PDF: ' + error.message);
            }
        }

        document.addEventListener('click', function (e) {
            if (!e.target.closest('.popup') && !e.target.classList.contains('day')) {
                document.getElementById('attendance-popup').style.display = 'none';
            }
        });
    </script>
</body>
</html>