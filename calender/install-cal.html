<script>
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    const waitMsg = document.getElementById('waitMsg');

    if ('serviceWorker' in navigator) { 
        navigator.serviceWorker.register('./sw-cal.js'); 
    }

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
        waitMsg.style.display = 'none';
    });

    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                // 1. ഇൻസ്റ്റാൾ ബട്ടൺ മറയ്ക്കുന്നു
                installBtn.style.display = 'none';
                
                // 2. ആദ്യം "Installing..." മെസ്സേജ് കാണിക്കുന്നു
                waitMsg.style.display = 'block';
                waitMsg.style.color = '#2563eb'; // ബ്ലൂ കളർ
                waitMsg.innerHTML = "<b>Installing... please wait</b>";
                
                // 3. മൂന്ന് സെക്കൻഡിന് ശേഷം "Success" മെസ്സേജിലേക്ക് മാറ്റുന്നു
                setTimeout(() => {
                    waitMsg.style.color = '#059669'; // പച്ച കളർ
                    waitMsg.innerHTML = "<b style='font-size:18px;'>Successfully Installed!</b>";
                    
                    // പേജ് ഓട്ടോമാറ്റിക്കായി ബാക്ക് ആകില്ല, യൂസർക്ക് തന്നെ തീരുമാനിക്കാം.
                }, 3000); 
            }
            deferredPrompt = null;
        }
    });

    if (window.matchMedia('(display-mode: standalone)').matches) {
        window.location.href = 'index.html';
    }
</script>
