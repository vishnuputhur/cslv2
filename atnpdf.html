<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance PDF</title>
    <style>
        body {
            display: none; /* Hide the page during PDF generation */
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #FFFFFF; /* White background */
        }

        .container {
            width: 195.9mm; /* Letter width (215.9mm) - 2x10mm margins */
            height: 259.4mm; /* Letter height (279.4mm) - 2x10mm margins */
            margin: 10mm; /* Equal 10mm margins on all sides */
            background-color: #FFFFFF; /* White background */
            border: 3px double #000000; /* Double-line black border */
            box-sizing: border-box;
            padding: 8px; /* Reduced padding for compact layout */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px; /* Reduced to save space */
            font-size: 12px;
            font-weight: bold;
            color: #000000;
        }

        .header span {
            flex: 1;
            text-align: center;
        }

        .header .name { text-align: left; }
        .header .code { text-align: center; }
        .header .date { text-align: right; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px; /* Reduced font size to fit more rows */
            font-weight: bold;
            margin-bottom: 8px; /* Reduced to save space */
        }

        th, td {
            border: 1px solid #000000; /* Black borders for table */
            padding: 3px; /* Reduced padding for compact rows */
            text-align: center;
            color: #000000;
        }

        th {
            background-color: #FFFFFF; /* White background for header */
            color: #000000;
        }

        .holiday { color: #FF0000; } /* Red for holidays */
        .leave-cl { background-color: #ADD8E6; } /* Light blue for CL */
        .leave-el { background-color: #C04070; color: #FFFFFF; } /* Pink for EL */
        .leave-hpl { background-color: #FFA07A; } /* Light salmon for HPL */
        .leave-special { background-color: #FFC0CB; } /* Light pink for Special */

        .summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 9px;
            font-weight: bold;
            color: #000000;
            margin-bottom: 8px; /* Reduced to save space */
        }

        .summary span {
            flex: 1;
            text-align: center;
        }

        .footer {
            text-align: center;
            font-size: 9px;
            font-weight: bold;
            color: #000000;
            position: absolute;
            bottom: -15px; /* Outside the double border */
            width: 100%;
        }

        #download-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #000000;
            color: #FFFFFF;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="download-message">Your download will start now</div>
    <div class="container" id="pdf-content">
        <div class="header">
            <span class="name" id="name"></span>
            <span class="code" id="code"></span>
            <span class="date" id="month"></span>
        </div>
        <table id="attendance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Shift</th>
                    <th>In Time</th>
                    <th>Out Time</th>
                    <th>Leave</th>
                    <th>OT</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
        <div class="summary">
            <span id="total-leave"></span>
            <span id="total-ot"></span>
            <span id="total-present"></span>
        </div>
        <div class="footer">Powered by VT@Soft</div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            if (!encodedData) {
                document.getElementById('download-message').innerText = 'Error: No data provided';
                document.getElementById('download-message').style.display = 'block';
                return;
            }

            try {
                const pdfData = JSON.parse(decodeURIComponent(encodedData));

                // Populate header
                document.getElementById('name').innerText = `Name: ${pdfData.name}`;
                document.getElementById('code').innerText = `Code: ${pdfData.code}`;
                document.getElementById('month').innerText = `Month: ${pdfData.month}`;

                // Populate table
                const tbody = document.getElementById('table-body');
                pdfData.table.forEach(row => {
                    const tr = document.createElement('tr');
                    if (row.isHoliday) tr.classList.add('holiday');
                    if (row.leaveType) tr.classList.add(`leave-${row.leaveType}`);
                    tr.innerHTML = `
                        <td>${row.date}</td>
                        <td>${row.shift}</td>
                        <td>${row.inTime}</td>
                        <td>${row.outTime}</td>
                        <td>${row.leave}</td>
                        <td>${row.ot}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Populate summary
                document.getElementById('total-leave').innerText = `Total Leave: ${pdfData.totalLeave}`;
                document.getElementById('total-ot').innerText = `Total OT: ${pdfData.totalOT} hrs`;
                document.getElementById('total-present').innerText = `Total Present: ${pdfData.totalPresent}`;

                // Show download message and trigger PDF generation
                document.getElementById('download-message').style.display = 'block';
                setTimeout(generatePDF, 100); // Small delay to ensure rendering
            } catch (error) {
                document.getElementById('download-message').innerText = 'Error: ' + error.message;
                document.getElementById('download-message').style.display = 'block';
                console.error('Error processing data:', error);
            }
        };

        function generatePDF() {
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'letter' // Letter size: 215.9mm Ã— 279.4mm
            });

            html2canvas(document.getElementById('pdf-content'), {
                scale: 2, // Higher scale for better quality
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgProps = doc.getImageProperties(imgData);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                // Save PDF with dynamic filename
                const month = document.getElementById('month').innerText.split(' ')[1] || 'Month';
                doc.save(`Attendance_${month}.pdf`);

                // Close the window after 5 seconds
                setTimeout(() => window.close(), 5000);
            }).catch(error => {
                document.getElementById('download-message').innerText = 'Error generating PDF: ' + error.message;
                console.error('Error generating PDF:', error);
            });
        }
    </script>
</body>
</html>