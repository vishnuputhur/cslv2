<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance PDF</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            display: none; /* Hide the page during PDF generation */
            font-family: 'Arial', sans-serif; /* Match pdfversion.html */
            margin: 0;
            padding: 0;
            background-color: #FFFFFF;
        }

        #download-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #000000;
            color: #FFFFFF;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
        }

        #content {
            display: none; /* Hidden, as PDF is generated directly */
        }
    </style>
</head>
<body>
    <div id="download-message">Your download will start now</div>
    <div id="content"></div>

    <script>
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'letter' // Letter size: 215.9mm × 279.4mm
        });

        const margin = 10; // 10mm margins
        const pageWidth = 215.9; // Letter width
        const pageHeight = 279.4; // Letter height
        const contentWidth = pageWidth - 2 * margin;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('data');
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' }).replace(/\//g, '');
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false }).replace(':', '');

        window.onload = function () {
            if (!encodedData) {
                document.getElementById('download-message').innerText = 'Error: No data provided';
                document.getElementById('download-message').style.display = 'block';
                return;
            }

            try {
                const pdfData = JSON.parse(decodeURIComponent(encodedData));
                const fileName = `Attendance_${pdfData.month.replace(' 2025', '')}_${dateStr}${timeStr}.pdf`;

                // Add page header and border
                function addPageHeaderAndBorder() {
                    doc.setLineWidth(0.5);
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(margin, margin, contentWidth, pageHeight - 2 * margin); // Double border
                    doc.setLineWidth(0.3);
                    doc.rect(margin + 0.5, margin + 0.5, contentWidth - 1, pageHeight - 2 * margin - 1);
                    doc.setFontSize(16);
                    doc.text('Cochin Shipyard Limited', margin + contentWidth / 2, margin + 10, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text(`Attendance Register`, margin + contentWidth / 2, margin + 20, { align: 'center' });
                    doc.text(`Date: ${now.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })}`, pageWidth - margin - 10, margin + 20, { align: 'right' });
                }

                // Single page
                addPageHeaderAndBorder();
                let startY = margin + 30;

                // Header (Name, Code, Month)
                doc.setFontSize(12);
                doc.text(`Name: ${pdfData.name}`, margin + 10, startY, { align: 'left' });
                doc.text(`Code: ${pdfData.code}`, margin + contentWidth / 2, startY, { align: 'center' });
                doc.text(`Month: ${pdfData.month}`, pageWidth - margin - 10, startY, { align: 'right' });
                startY += 10;

                // Table
                const tableData = pdfData.table.map(row => {
                    const color = row.isHoliday ? [220, 38, 38] : row.leaveType === 'cl' ? [173, 216, 230] :
                        row.leaveType === 'el' ? [192, 64, 112] : row.leaveType === 'hpl' ? [255, 160, 122] :
                        row.leaveType === 'special' ? [255, 192, 203] : [0, 0, 0];
                    return [
                        { content: row.date, styles: { textColor: color } },
                        { content: row.shift, styles: { textColor: color } },
                        { content: row.inTime, styles: { textColor: color } },
                        { content: row.outTime, styles: { textColor: color } },
                        { content: row.leave, styles: { textColor: color } },
                        { content: row.ot, styles: { textColor: color } }
                    ];
                });

                doc.autoTable({
                    startY: startY,
                    head: [['Date', 'Shift', 'In Time', 'Out Time', 'Leave', 'OT']],
                    body: tableData,
                    theme: 'grid',
                    styles: { halign: 'center', cellPadding: 1, fontSize: 8, lineHeight: 1.2, font: 'Arial', fontStyle: 'bold' },
                    headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], fontStyle: 'bold' },
                    margin: { left: margin + 10, right: margin + 10 },
                    tableWidth: contentWidth - 20
                });

                // Summary
                let footerY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(8);
                doc.setFont('Arial', 'bold');
                doc.text(`Total Leave: ${pdfData.totalLeave}`, margin + 10, footerY, { align: 'left' });
                doc.text(`Total OT: ${pdfData.totalOT} hrs`, margin + contentWidth / 2, footerY, { align: 'center' });
                doc.text(`Total Present: ${pdfData.totalPresent}`, pageWidth - margin - 10, footerY, { align: 'right' });

                // Footer
                doc.text('Powered by VT@Soft © 2025', margin + contentWidth / 2, pageHeight - margin - 5, { align: 'center' });

                // Show download message and save PDF
                document.getElementById('download-message').style.display = 'block';
                setTimeout(() => {
                    doc.save(fileName);
                    setTimeout(() => window.close(), 5000);
                }, 500);
            } catch (error) {
                document.getElementById('download-message').innerText = 'Error: ' + error.message;
                document.getElementById('download-message').style.display = 'block';
                console.error('Error processing data:', error);
            }
        };
    </script>
</body>
</html>